# EcoWiki 文章审核系统使用文档

## 📖 系统概述

EcoWiki 文章审核系统是一个完整的内容审核解决方案，支持文章的创建、更新、删除等操作的审核流程。系统采用基于角色的权限控制（RBAC），支持自动分配审核员、消息通知、审核历史跟踪等功能。

## 🏗️ 系统架构

### 技术栈
- **后端**: Spring Boot 3.x + JPA/Hibernate + MySQL
- **前端**: Vue 3 + TypeScript + Vite
- **数据库**: MySQL 8.0+
- **权限系统**: RBAC (基于角色的访问控制)

### 核心组件
1. **数据库层**: 审核表、权限配置、分配记录、历史表
2. **后端服务层**: 实体类、Repository、Service、Controller
3. **前端界面层**: Vue组件、API服务、类型定义

## 🚀 安装部署

### 1. 数据库初始化

执行数据库初始化脚本：
```sql
-- 执行审核系统数据库脚本
SOURCE /path/to/ARTICLE_REVIEW_SYSTEM_INIT.sql;
```

### 2. 后端配置

确保以下依赖已添加到 `pom.xml`：
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
```

### 3. 前端配置

安装前端依赖：
```bash
cd www/frontend
npm install
# 或
pnpm install
```

## 📊 数据库结构

### 核心表结构

#### 1. article_review (审核主表)
```sql
CREATE TABLE article_review (
    review_id INT PRIMARY KEY AUTO_INCREMENT,
    article_id INT NOT NULL,
    submitter_id INT NOT NULL,
    reviewer_id INT,
    review_type ENUM('CREATE', 'UPDATE', 'DELETE') NOT NULL,
    status ENUM('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED') DEFAULT 'PENDING',
    priority INT DEFAULT 2,
    content_snapshot TEXT,
    review_reason TEXT,
    submit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    review_time TIMESTAMP NULL,
    deadline TIMESTAMP NULL,
    auto_publish BOOLEAN DEFAULT FALSE,
    INDEX idx_article_id (article_id),
    INDEX idx_status (status),
    INDEX idx_reviewer_id (reviewer_id)
);
```

#### 2. reviewer_assignment (审核员分配表)
```sql
CREATE TABLE reviewer_assignment (
    assignment_id INT PRIMARY KEY AUTO_INCREMENT,
    review_id INT NOT NULL,
    reviewer_id INT NOT NULL,
    assigner_id INT NOT NULL,
    assignment_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('ACTIVE', 'ACCEPTED', 'REJECTED', 'CANCELLED', 'COMPLETED') DEFAULT 'ACTIVE',
    assignment_reason TEXT,
    auto_assigned BOOLEAN DEFAULT FALSE,
    weight_score DECIMAL(5,2),
    expected_completion_time TIMESTAMP NULL,
    FOREIGN KEY (review_id) REFERENCES article_review(review_id)
);
```

#### 3. review_history (审核历史表)
```sql
CREATE TABLE review_history (
    history_id INT PRIMARY KEY AUTO_INCREMENT,
    review_id INT NOT NULL,
    operator_id INT NOT NULL,
    action_type ENUM('CREATED', 'ASSIGNED', 'APPROVED', 'REJECTED', 'CANCELLED') NOT NULL,
    old_status ENUM('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED'),
    new_status ENUM('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED'),
    action_description TEXT,
    action_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (review_id) REFERENCES article_review(review_id)
);
```

## 🔧 API 接口文档

### 基础URL
```
http://your-domain/api/review
```

### 1. 创建审核申请

**POST** `/api/review/create`

**请求参数:**
```json
{
  "articleId": 123,
  "submitterId": 1,
  "reviewType": "CREATE",
  "contentSnapshot": "文章内容快照",
  "autoPublish": true
}
```

**响应示例:**
```json
{
  "success": true,
  "message": "审核申请创建成功",
  "data": {
    "reviewId": 1,
    "articleId": 123,
    "submitterId": 1,
    "reviewType": "CREATE",
    "status": "PENDING",
    "submitTime": "2025-07-25T10:00:00Z"
  }
}
```

### 2. 分配审核员

**POST** `/api/review/{reviewId}/assign`

**请求参数:**
```json
{
  "reviewerId": 2,
  "assignerId": 1,
  "reason": "专业领域匹配"
}
```

### 3. 处理审核

**POST** `/api/review/{reviewId}/process`

**请求参数:**
```json
{
  "reviewerId": 2,
  "approved": true,
  "reason": "内容质量良好，符合发布标准"
}
```

### 4. 获取审核列表

**GET** `/api/review/list`

**查询参数:**
- `page`: 页码 (默认: 0)
- `size`: 每页大小 (默认: 10)
- `status`: 审核状态筛选
- `reviewType`: 审核类型筛选

### 5. 获取审核详情

**GET** `/api/review/{reviewId}`

**响应示例:**
```json
{
  "success": true,
  "data": {
    "review": {
      "reviewId": 1,
      "articleId": 123,
      "status": "PENDING",
      "reviewType": "CREATE"
    },
    "history": [
      {
        "actionType": "CREATED",
        "actionTime": "2025-07-25T10:00:00Z",
        "operatorId": 1
      }
    ]
  }
}
```

## 🎯 功能使用指南

### 1. 创建审核申请

#### 管理员/编辑员操作：
1. 进入审核管理界面
2. 点击"创建审核"按钮
3. 填写审核信息：
   - **文章ID**: 需要审核的文章ID
   - **审核类型**: 选择CREATE（创建）、UPDATE（更新）、DELETE（删除）
   - **内容快照**: 可选，记录当前内容状态
   - **自动发布**: 勾选后审核通过将自动发布

#### 代码示例：
```typescript
// 前端调用示例
import { reviewApi } from '@/api/review';

const createReview = async () => {
  const response = await reviewApi.create({
    articleId: 123,
    submitterId: getCurrentUserId(),
    reviewType: 'CREATE',
    contentSnapshot: getArticleContent(),
    autoPublish: true
  });
  
  if (response.success) {
    console.log('审核申请创建成功');
  }
};
```

### 2. 审核员分配

#### 自动分配：
系统将根据以下策略自动分配审核员：
- **负载均衡**: 选择当前工作量最少的审核员
- **专业匹配**: 根据文章分类匹配相应专业的审核员
- **权限验证**: 确保审核员具有相应权限

#### 手动分配：
1. 在审核列表中找到待分配的审核
2. 点击"分配审核员"按钮
3. 选择合适的审核员
4. 填写分配原因
5. 确认分配

#### 代码示例：
```java
// 后端自动分配逻辑
@Service
public class ArticleReviewService {
    
    public void assignReviewer(Integer reviewId) {
        // 1. 获取具有审核权限的用户
        List<User> availableReviewers = getAvailableReviewers();
        
        // 2. 计算负载和专业匹配分数
        User bestReviewer = findBestReviewer(availableReviewers);
        
        // 3. 创建分配记录
        ReviewerAssignment assignment = new ReviewerAssignment();
        assignment.setReviewId(reviewId);
        assignment.setReviewerId(bestReviewer.getUserId());
        assignment.setAutoAssigned(true);
        
        // 4. 发送通知消息
        messageService.sendMessage(
            bestReviewer.getUserId(),
            "您有新的文章审核任务"
        );
    }
}
```

### 3. 审核处理

#### 审核员操作流程：
1. 登录系统，查看待审核列表
2. 点击具体审核项目查看详情
3. 仔细阅读文章内容和审核要求
4. 选择审核结果：
   - **通过**: 文章符合发布标准
   - **拒绝**: 文章存在问题，需要修改
5. 填写审核意见和建议
6. 提交审核结果

#### 系统自动处理：
- 审核通过且设置自动发布：系统自动发布文章
- 发送通知给文章作者
- 记录审核历史
- 更新审核状态

### 4. 权限管理

#### 权限配置：
```sql
-- 为角色添加审核权限
INSERT INTO role_permissions (role_id, permission_name, permission_value) VALUES
(2, 'review.create', 'true'),      -- 编辑员可以创建审核
(3, 'review.process', 'true'),     -- 审核员可以处理审核
(1, 'review.manage', 'true');      -- 管理员可以管理所有审核
```

#### 权限检查：
```java
// 权限验证示例
@PreAuthorize("hasPermission('review.create')")
public ResponseEntity<ApiResponse<ArticleReview>> createReview(
    @RequestBody CreateReviewRequest request) {
    // 创建审核逻辑
}

@PreAuthorize("hasPermission('review.process')")
public ResponseEntity<ApiResponse> processReview(
    @PathVariable Integer reviewId,
    @RequestBody ProcessReviewRequest request) {
    // 处理审核逻辑
}
```

## 🔔 消息通知系统

### 通知触发时机：
1. **创建审核**: 通知管理员有新的审核申请
2. **分配审核员**: 通知被分配的审核员
3. **审核完成**: 通知文章作者审核结果
4. **审核超期**: 提醒审核员处理超期任务

### 消息模板：
```java
// 消息发送示例
public class ReviewNotificationService {
    
    public void sendReviewAssignedNotification(Integer reviewerId, Integer reviewId) {
        String message = String.format(
            "您有新的文章审核任务，审核ID: %d，请及时处理。",
            reviewId
        );
        messageService.sendMessage(reviewerId, message);
    }
    
    public void sendReviewCompletedNotification(Integer submitterId, boolean approved) {
        String message = approved 
            ? "您的文章审核已通过，文章已发布。"
            : "您的文章审核未通过，请根据审核意见修改后重新提交。";
        messageService.sendMessage(submitterId, message);
    }
}
```

## 📈 统计和监控

### 1. 审核统计

#### 可查看的统计信息：
- 总审核数量
- 待审核数量
- 通过/拒绝数量
- 平均审核时间
- 超期审核数量

#### 前端展示：
```vue
<template>
  <div class="statistics-grid">
    <div class="stat-card">
      <div class="stat-number">{{ statistics.totalReviews }}</div>
      <div class="stat-label">总审核数</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ statistics.pendingCount }}</div>
      <div class="stat-label">待审核</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ statistics.approvedCount }}</div>
      <div class="stat-label">已通过</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ statistics.avgReviewTimeHours }}h</div>
      <div class="stat-label">平均审核时间</div>
    </div>
  </div>
</template>
```

### 2. 审核历史

#### 历史记录包含：
- 操作时间
- 操作人员
- 操作类型
- 状态变更
- 操作描述

## 🛠️ 维护和故障排除

### 常见问题解决

#### 1. 审核员自动分配失败
**原因**: 没有符合条件的审核员
**解决方案**: 
- 检查审核员权限配置
- 确保有足够的审核员在线
- 检查专业领域匹配规则

#### 2. 消息通知未发送
**原因**: 消息服务异常或权限不足
**解决方案**:
- 检查消息服务状态
- 验证用户权限
- 查看系统日志

#### 3. 审核状态同步问题
**原因**: 数据库事务异常或并发操作
**解决方案**:
- 检查数据库连接
- 重启相关服务
- 手动修复数据状态

### 日志监控

#### 关键日志位置：
```
logs/review-service.log     # 审核服务日志
logs/notification.log       # 通知服务日志
logs/database.log          # 数据库操作日志
```

#### 监控指标：
- API响应时间
- 审核处理速度
- 错误率统计
- 用户活跃度

## 🔐 安全考虑

### 1. 权限控制
- 基于角色的访问控制（RBAC）
- API接口权限验证
- 敏感操作日志记录

### 2. 数据安全
- 输入参数验证
- SQL注入防护
- XSS攻击防护

### 3. 操作审计
- 完整的操作历史记录
- 用户行为追踪
- 异常操作告警

## 📝 最佳实践

### 1. 审核流程优化
- 设置合理的审核优先级
- 建立审核员专业分组
- 定期评估审核效率

### 2. 用户体验
- 清晰的状态提示
- 及时的消息通知
- 友好的错误处理

### 3. 系统维护
- 定期清理历史数据
- 监控系统性能
- 及时更新权限配置

## 📞 技术支持

如需技术支持，请联系：
- 邮箱: support@ecowiki.com
- 技术文档: https://docs.ecowiki.com
- 问题反馈: https://github.com/ecowiki/issues

---

**版本**: 1.0.0  
**更新时间**: 2025年7月25日  
**维护团队**: EcoWiki开发团队
