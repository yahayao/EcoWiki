# 文章审核系统调试指南

## 🔍 系统调试步骤

### 1. 前端调试

#### 检查浏览器控制台错误
```bash
# 打开浏览器开发者工具 (F12)
# 查看 Console 标签页中的错误信息
# 查看 Network 标签页中的API请求状态
```

#### 常见前端问题

**问题1: 审核列表无法加载**
```javascript
// 检查API调用
console.log('API Base URL:', '/api/review');
console.log('Request Headers:', axios.defaults.headers);

// 检查响应数据
axios.get('/api/review/list')
  .then(response => console.log('Response:', response.data))
  .catch(error => console.error('Error:', error));
```

**问题2: 创建审核对话框报错**
```javascript
// 检查表单数据
console.log('Form Data:', {
  articleId: form.articleId,
  reviewType: form.reviewType,
  submitterId: form.submitterId
});

// 检查类型定义
import { ReviewType } from '@/types/review';
console.log('Available Review Types:', Object.values(ReviewType));
```

### 2. 后端调试

#### 检查服务启动状态
```bash
# 检查Spring Boot应用是否启动成功
curl http://localhost:8080/actuator/health

# 检查审核API端点
curl http://localhost:8080/api/review/health
```

#### 检查数据库连接
```sql
-- 检查数据库表是否创建成功
SHOW TABLES LIKE '%review%';

-- 检查表结构
DESCRIBE article_review;
DESCRIBE reviewer_assignment;
DESCRIBE review_history;

-- 检查基础数据
SELECT COUNT(*) FROM article_review;
SELECT COUNT(*) FROM user_roles WHERE permission_name LIKE '%review%';
```

#### 后端日志调试
```java
// 在 ArticleReviewService 中添加调试日志
@Slf4j
@Service
public class ArticleReviewService {
    
    public ArticleReview createReview(CreateReviewRequest request) {
        log.debug("创建审核申请: {}", request);
        
        try {
            // 验证文章是否存在
            if (!articleRepository.existsById(request.getArticleId())) {
                log.error("文章不存在: {}", request.getArticleId());
                throw new IllegalArgumentException("文章不存在");
            }
            
            // 创建审核记录
            ArticleReview review = new ArticleReview();
            // ... 设置属性
            
            ArticleReview saved = articleReviewRepository.save(review);
            log.info("审核申请创建成功: {}", saved.getReviewId());
            
            return saved;
        } catch (Exception e) {
            log.error("创建审核申请失败", e);
            throw e;
        }
    }
}
```

### 3. 数据库调试

#### 检查权限配置
```sql
-- 检查用户角色权限
SELECT u.username, r.role_name, rp.permission_name, rp.permission_value
FROM users u
JOIN user_roles ur ON u.user_id = ur.user_id
JOIN roles r ON ur.role_id = r.role_id
JOIN role_permissions rp ON r.role_id = rp.role_id
WHERE rp.permission_name LIKE '%review%';

-- 检查审核员列表
SELECT u.user_id, u.username, COUNT(ar.review_id) as pending_reviews
FROM users u
JOIN user_roles ur ON u.user_id = ur.user_id
JOIN role_permissions rp ON ur.role_id = rp.role_id
LEFT JOIN article_review ar ON u.user_id = ar.reviewer_id AND ar.status = 'PENDING'
WHERE rp.permission_name = 'review.process' AND rp.permission_value = 'true'
GROUP BY u.user_id, u.username;
```

#### 检查审核数据
```sql
-- 检查审核记录状态分布
SELECT status, COUNT(*) as count
FROM article_review
GROUP BY status;

-- 检查最近的审核记录
SELECT review_id, article_id, submitter_id, reviewer_id, status, submit_time
FROM article_review
ORDER BY submit_time DESC
LIMIT 10;

-- 检查审核历史记录
SELECT rh.*, u.username as operator_name
FROM review_history rh
JOIN users u ON rh.operator_id = u.user_id
ORDER BY rh.action_time DESC
LIMIT 10;
```

## 🐛 常见问题解决方案

### 问题1: 审核员自动分配失败

**症状**: 创建审核后没有自动分配审核员

**调试步骤**:
1. 检查是否有具备审核权限的用户
2. 检查自动分配算法是否正常
3. 检查消息服务是否正常

**解决方案**:
```java
// 在 ArticleReviewService 中添加调试代码
public void assignReviewer(Integer reviewId) {
    log.debug("开始自动分配审核员, reviewId: {}", reviewId);
    
    // 1. 获取所有审核员
    List<User> reviewers = getAvailableReviewers();
    log.debug("可用审核员数量: {}", reviewers.size());
    
    if (reviewers.isEmpty()) {
        log.error("没有可用的审核员");
        throw new IllegalStateException("没有可用的审核员");
    }
    
    // 2. 选择最佳审核员
    User bestReviewer = findBestReviewer(reviewers);
    log.debug("选择的审核员: {}", bestReviewer.getUsername());
    
    // 3. 创建分配记录
    // ... 分配逻辑
}
```

### 问题2: 消息通知未发送

**症状**: 审核状态变更后用户未收到通知

**调试步骤**:
```java
// 检查消息服务
@Autowired
private MessageService messageService;

public void sendNotification(Integer userId, String message) {
    try {
        log.debug("发送消息给用户 {}: {}", userId, message);
        messageService.sendMessage(userId, message);
        log.info("消息发送成功");
    } catch (Exception e) {
        log.error("消息发送失败", e);
        // 这里可以添加重试逻辑或者记录到失败队列
    }
}
```

### 问题3: 前端页面空白或组件加载失败

**症状**: 审核管理页面显示空白或组件报错

**调试步骤**:
1. 检查浏览器控制台错误
2. 检查Vue组件是否正确导入
3. 检查API接口是否正常

**解决方案**:
```vue
<template>
  <div class="review-dashboard">
    <!-- 添加加载状态 -->
    <div v-if="loading" class="loading">
      正在加载审核数据...
    </div>
    
    <!-- 添加错误状态 -->
    <div v-else-if="error" class="error">
      <p>加载失败: {{ error.message }}</p>
      <button @click="reload">重新加载</button>
    </div>
    
    <!-- 正常内容 -->
    <div v-else>
      <!-- 审核管理内容 -->
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';

const loading = ref(true);
const error = ref<Error | null>(null);

const loadReviewData = async () => {
  try {
    loading.value = true;
    error.value = null;
    
    // 加载数据的逻辑
    await loadReviews();
    await loadStatistics();
    
  } catch (e: any) {
    console.error('加载审核数据失败:', e);
    error.value = e;
  } finally {
    loading.value = false;
  }
};

const reload = () => {
  loadReviewData();
};

onMounted(() => {
  loadReviewData();
});
</script>
```

## 🔧 性能优化建议

### 1. 数据库优化

```sql
-- 添加必要的索引
CREATE INDEX idx_article_review_status_time ON article_review(status, submit_time);
CREATE INDEX idx_reviewer_assignment_reviewer_status ON reviewer_assignment(reviewer_id, status);
CREATE INDEX idx_review_history_review_time ON review_history(review_id, action_time);

-- 定期清理历史数据
DELETE FROM review_history 
WHERE action_time < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

### 2. 前端性能优化

```vue
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';

// 使用分页减少数据量
const pageSize = ref(20);
const currentPage = ref(1);

// 使用计算属性缓存处理结果
const filteredReviews = computed(() => {
  return reviews.value.filter(review => {
    // 筛选逻辑
  });
});

// 使用防抖减少API调用
import { debounce } from 'lodash-es';

const searchReviews = debounce(async (keyword: string) => {
  // 搜索逻辑
}, 300);
</script>
```

### 3. 后端性能优化

```java
// 使用缓存减少数据库查询
@Cacheable(value = "reviewStatistics", key = "#reviewerId")
public ReviewStatistics getReviewStatistics(Integer reviewerId) {
    // 统计逻辑
}

// 使用异步处理减少响应时间
@Async
public void sendNotificationAsync(Integer userId, String message) {
    messageService.sendMessage(userId, message);
}

// 使用批量操作提高效率
public void batchProcessReviews(List<Integer> reviewIds, String action) {
    List<ArticleReview> reviews = articleReviewRepository.findAllById(reviewIds);
    // 批量处理逻辑
    articleReviewRepository.saveAll(reviews);
}
```

## 📊 监控和告警

### 1. 关键指标监控

```java
// 添加监控指标
@Component
public class ReviewMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter reviewCreatedCounter;
    private final Timer reviewProcessingTimer;
    
    public ReviewMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.reviewCreatedCounter = Counter.builder("review.created")
            .description("审核创建数量")
            .register(meterRegistry);
        this.reviewProcessingTimer = Timer.builder("review.processing.time")
            .description("审核处理时间")
            .register(meterRegistry);
    }
    
    public void incrementReviewCreated() {
        reviewCreatedCounter.increment();
    }
    
    public void recordProcessingTime(Duration duration) {
        reviewProcessingTimer.record(duration);
    }
}
```

### 2. 健康检查

```java
// 添加健康检查端点
@RestController
@RequestMapping("/api/review")
public class ReviewHealthController {
    
    @GetMapping("/health")
    public ResponseEntity<Map<String, Object>> health() {
        Map<String, Object> status = new HashMap<>();
        
        try {
            // 检查数据库连接
            long count = articleReviewRepository.count();
            status.put("database", "UP");
            status.put("reviewCount", count);
            
            // 检查消息服务
            boolean messageServiceUp = checkMessageService();
            status.put("messageService", messageServiceUp ? "UP" : "DOWN");
            
            status.put("status", "UP");
            return ResponseEntity.ok(status);
            
        } catch (Exception e) {
            status.put("status", "DOWN");
            status.put("error", e.getMessage());
            return ResponseEntity.status(503).body(status);
        }
    }
}
```

## 📝 调试日志配置

```yaml
# application.yml 中的日志配置
logging:
  level:
    com.ecowiki.service.ArticleReviewService: DEBUG
    com.ecowiki.controller.ArticleReviewController: DEBUG
    org.springframework.web: DEBUG
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/review-system.log
    max-size: 100MB
    max-history: 30
```

---

**提示**: 遇到问题时，建议按照以上步骤逐一排查，并查看相关日志信息。如果问题仍未解决，请联系技术支持团队。
