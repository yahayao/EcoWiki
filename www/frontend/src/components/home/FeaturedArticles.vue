<!--
  ç²¾é€‰æ–‡ç« ç»„ä»¶
  
  è¯¥ç»„ä»¶å±•ç¤ºWikiç³»ç»Ÿä¸­çš„çƒ­é—¨å’Œç²¾é€‰æ–‡ç« ï¼Œä¸ºç”¨æˆ·æä¾›é«˜è´¨é‡å†…å®¹çš„å¿«é€Ÿè®¿é—®å…¥å£ã€‚
  é‡‡ç”¨å¡ç‰‡å¼å¸ƒå±€è®¾è®¡ï¼Œæ”¯æŒå“åº”å¼æ˜¾ç¤ºå’Œä¸°å¯Œçš„æ–‡ç« ä¿¡æ¯å±•ç¤ºã€‚
  
  ä¸»è¦åŠŸèƒ½ï¼š
  - çƒ­é—¨æ–‡ç« å±•ç¤ºï¼šå±•ç¤ºé«˜æµè§ˆé‡å’Œé«˜ç‚¹èµæ•°çš„ç²¾é€‰æ–‡ç« 
  - æ–‡ç« ä¿¡æ¯é¢„è§ˆï¼šæä¾›æ ‡é¢˜ã€æ‘˜è¦ã€ä½œè€…ã€åˆ†ç±»ç­‰æ ¸å¿ƒä¿¡æ¯
  - å¿«é€Ÿå¯¼èˆªï¼šæ”¯æŒç‚¹å‡»è·³è½¬åˆ°æ–‡ç« è¯¦æƒ…é¡µé¢
  - æ ‡ç­¾ç³»ç»Ÿï¼šå±•ç¤ºæ–‡ç« ç›¸å…³æ ‡ç­¾ï¼Œä¾¿äºåˆ†ç±»æµè§ˆ
  - ç»Ÿè®¡ä¿¡æ¯ï¼šæ˜¾ç¤ºæµè§ˆé‡ã€ç‚¹èµæ•°ç­‰äº’åŠ¨æ•°æ®
  
  æ•°æ®å±•ç¤ºï¼š
  - æ–‡ç« æ ‡é¢˜ï¼šæ¸…æ™°çš„æ ‡é¢˜å±•ç¤º
  - å†…å®¹æ‘˜è¦ï¼šè‡ªåŠ¨æˆªå–æ–‡ç« å¼€å¤´ä½œä¸ºé¢„è§ˆ
  - ä½œè€…ä¿¡æ¯ï¼šæ˜¾ç¤ºæ–‡ç« ä½œè€…åç§°
  - å‘å¸ƒæ—¶é—´ï¼šæ ¼å¼åŒ–çš„å‘å¸ƒæ—¥æœŸ
  - åˆ†ç±»æ ‡ç­¾ï¼šæ–‡ç« æ‰€å±åˆ†ç±»å’Œè‡ªå®šä¹‰æ ‡ç­¾
  - äº’åŠ¨ç»Ÿè®¡ï¼šæµè§ˆé‡å’Œç‚¹èµæ•°å®æ—¶æ˜¾ç¤º
  
  è§†è§‰è®¾è®¡ï¼š
  - å¡ç‰‡å¼å¸ƒå±€ï¼šæ¯ç¯‡æ–‡ç« ç‹¬ç«‹çš„å¡ç‰‡å®¹å™¨
  - ç½‘æ ¼æ’åˆ—ï¼šå“åº”å¼ç½‘æ ¼å¸ƒå±€é€‚é…ä¸åŒå±å¹•
  - çŠ¶æ€åé¦ˆï¼šåŠ è½½ã€é”™è¯¯ã€ç©ºæ•°æ®çš„è§†è§‰æç¤º
  - æ‚¬æµ®æ•ˆæœï¼šé¼ æ ‡æ‚¬åœæ—¶çš„äº¤äº’åé¦ˆ
  - å›¾æ ‡åŒ–è¡¨ç¤ºï¼šä½¿ç”¨è¡¨æƒ…ç¬¦å·å¢å¼ºè§†è§‰è¡¨è¾¾
  
  æŠ€æœ¯å®ç°ï¼š
  - Vue 3 Composition API
  - å¼‚æ­¥æ•°æ®åŠ è½½å’ŒçŠ¶æ€ç®¡ç†
  - Wikiè¯­æ³•è§£æå’Œå†…å®¹æ‘˜è¦æå–
  - è·¯ç”±å¯¼èˆªé›†æˆ
  - å“åº”å¼è®¾è®¡å’ŒCSS Gridå¸ƒå±€
  
  ä½¿ç”¨åœºæ™¯ï¼š
  - é¦–é¡µçƒ­é—¨å†…å®¹å±•ç¤º
  - æ¨èæ–‡ç« åˆ—è¡¨
  - å†…å®¹å‘ç°å’Œå¯¼èˆª
  - ç”¨æˆ·æµè§ˆå†…å®¹çš„å…¥å£
  
  æ‰©å±•æ€§ï¼š
  - æ”¯æŒä¸åŒçš„æ’åºæ–¹å¼ï¼ˆçƒ­åº¦ã€æ—¶é—´ã€è¯„åˆ†ç­‰ï¼‰
  - å¯æ·»åŠ æ–‡ç« åˆ†ç±»ç­›é€‰
  - æ”¯æŒä¸ªæ€§åŒ–æ¨èç®—æ³•
  - å¯é›†æˆæ”¶è—å’Œåˆ†äº«åŠŸèƒ½
  
  @author EcoWiki Team
  @version 1.0.0
  @since 2024-01-01
-->
<template>
  <!-- ç²¾é€‰æ–‡ç« å®¹å™¨ -->
  <div class="featured-articles">
    <!-- åŒºåŸŸæ ‡é¢˜ -->
    <h2 class="section-title"><IconFire color="red"></IconFire> çƒ­é—¨å†…å®¹</h2>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="loading" class="loading-container">
      <div class="loading-spinner"></div>
      <span>åŠ è½½ä¸­...</span>
    </div>
    
    <!-- é”™è¯¯çŠ¶æ€ -->
    <div v-else-if="error" class="error-container">
      <span><IconCross color="red"></IconCross> åŠ è½½å¤±è´¥: {{ error }}</span>
    </div>
    
    <!-- æ–‡ç« ç½‘æ ¼ -->
    <div v-else class="article-grid">
      <!-- å•ä¸ªæ–‡ç« å¡ç‰‡ -->
      <div 
        v-for="article in articles" 
        :key="article.articleId"
        class="article-card" 
        @click="navigateToArticle(article.title.toString())"
      >
        <!-- æ–‡ç« å¤´éƒ¨ä¿¡æ¯ -->
        <div class="article-header">
          <span class="article-category">{{ article.category || 'æœªåˆ†ç±»' }}</span>
          <span class="article-stats">ğŸ‘ {{ article.views }} | ğŸ‘ {{ article.likes }}</span>
        </div>
        
        <!-- æ–‡ç« æ ‡é¢˜ -->
        <h3 class="article-title">{{ article.title }}</h3>
        
        <!-- æ–‡ç« æ‘˜è¦ -->
        <p class="article-excerpt">{{ getArticleExcerpt(article.content) }}</p>
        
        <!-- æ–‡ç« æ ‡ç­¾ -->
        <div v-if="article.tags" class="article-tags">
          <span v-for="tag in getTagArray(article.tags)" :key="tag" class="tag">{{ tag }}</span>
        </div>
        
        <!-- æ–‡ç« å…ƒä¿¡æ¯ -->
        <div class="article-meta">
          <div class="article-author">
            <UserAvatar 
              :username="article.author"
              :avatar-url="article.authorAvatar || ''"
              size="xs"
              shape="circle"
            />
            <span class="author-name">{{ article.author }}</span>
          </div>
          <span class="article-date">{{ formatDate(article.publishDate) }}</span>
        </div>
      </div>
    </div>
    
    <!-- ç©ºæ•°æ®çŠ¶æ€ -->
    <div v-if="!loading && !error && articles.length === 0" class="empty-container">
      <span>ğŸ“ æš‚æ— æ–‡ç« </span>
    </div>
  </div>
</template>

<script setup lang="ts">
/**
 * ç²¾é€‰æ–‡ç« ç»„ä»¶è„šæœ¬
 * 
 * è¯¥è„šæœ¬å¤„ç†ç²¾é€‰æ–‡ç« çš„æ•°æ®è·å–ã€çŠ¶æ€ç®¡ç†å’Œç”¨æˆ·äº¤äº’ã€‚
 * é›†æˆWikiè§£æå™¨è¿›è¡Œå†…å®¹æ‘˜è¦æå–ï¼Œæä¾›ä¸°å¯Œçš„æ–‡ç« é¢„è§ˆä½“éªŒã€‚
 */

import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { articleApi, type Article } from '../../api/article'
import { wikiParser } from '../../utils/wikiParser'
import { IconFire, IconCross } from '../icons'
import UserAvatar from '@/components/common/UserAvatar.vue'

// è·¯ç”±å®ä¾‹
const router = useRouter()

// å“åº”å¼æ•°æ®å®šä¹‰
const articles = ref<Article[]>([])  // ç²¾é€‰æ–‡ç« åˆ—è¡¨
const loading = ref(true)            // åŠ è½½çŠ¶æ€æ ‡è¯†
const error = ref('')                // é”™è¯¯ä¿¡æ¯

/**
 * å¯¼èˆªåˆ°æ–‡ç« è¯¦æƒ…é¡µ
 * @param articleTitle æ–‡ç« ID
 */
const navigateToArticle = (articleTitle: string) => {
  router.push(`/wiki/${articleTitle}`)
}

/**
 * è·å–æ–‡ç« å†…å®¹æ‘˜è¦
 * ä½¿ç”¨Wikiè§£æå™¨æå–æ–‡ç« çš„çº¯æ–‡æœ¬æ‘˜è¦ï¼Œä¿æŒåŸæœ‰çš„æ¢è¡Œæ ¼å¼
 * @param content æ–‡ç« åŸå§‹å†…å®¹
 * @returns æ ¼å¼åŒ–çš„æ‘˜è¦æ–‡æœ¬
 */
const getArticleExcerpt = (content: string): string => {
  if (!content) return 'æš‚æ— å†…å®¹...'
  
  // ç›´æ¥å¤„ç†åŸå§‹å†…å®¹ï¼Œä¿æŒæ¢è¡Œå’Œæ ¼å¼
  let text = content
    // ç§»é™¤Wikiè¯­æ³•æ ‡è®°ï¼Œä½†ä¿æŒæ–‡æœ¬ç»“æ„
    .replace(/\[\[Category:[^\]]+\]\]/g, '') // ç§»é™¤åˆ†ç±»æ ‡ç­¾
    .replace(/={1,6}\s*([^=\n]+)\s*={1,6}/g, '$1') // ç§»é™¤æ ‡é¢˜ç¬¦å·ï¼Œä¿ç•™æ ‡é¢˜æ–‡æœ¬
    .replace(/'''([^']+)'''/g, '$1') // ç§»é™¤ç²—ä½“æ ‡è®°
    .replace(/''([^']+)''/g, '$1') // ç§»é™¤æ–œä½“æ ‡è®°
    .replace(/__([^_]+)__/g, '$1') // ç§»é™¤ä¸‹åˆ’çº¿æ ‡è®°
    .replace(/\[\[([^\]|]+)(\|[^\]]+)?\]\]/g, '$1') // ç®€åŒ–å†…éƒ¨é“¾æ¥
    .replace(/\[([^\s]+)\s+([^\]]+)\]/g, '$2') // ç®€åŒ–å¤–éƒ¨é“¾æ¥
    .replace(/<[^>]+>/g, '') // ç§»é™¤HTMLæ ‡ç­¾
    .replace(/\{\{[^}]+\}\}/g, '') // ç§»é™¤æ¨¡æ¿
    .replace(/^\s*[\*#]+\s*/gm, '') // ç§»é™¤åˆ—è¡¨æ ‡è®°ï¼Œä¿æŒåˆ—è¡¨å†…å®¹
    .trim()
  
  // å¦‚æœæ–‡æœ¬å¤ªé•¿ï¼Œæˆªå–å‰150ä¸ªå­—ç¬¦ï¼Œä½†åœ¨åˆé€‚çš„ä½ç½®æˆªæ–­
  if (text.length > 150) {
    text = text.substring(0, 150)
    // å°è¯•åœ¨å¥å·ã€æ„Ÿå¹å·ã€é—®å·å¤„æˆªæ–­
    const lastPunctuation = Math.max(
      text.lastIndexOf('ã€‚'),
      text.lastIndexOf('ï¼'), 
      text.lastIndexOf('ï¼Ÿ'),
      text.lastIndexOf('.')
    )
    if (lastPunctuation > 100) {
      text = text.substring(0, lastPunctuation + 1)
    } else {
      text = text + '...'
    }
  }
  
  return text || 'æš‚æ— å†…å®¹...'
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
 * å°†ISOæ—¥æœŸå­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸­æ–‡æ—¥æœŸæ ¼å¼
 * @param dateString æ—¥æœŸå­—ç¬¦ä¸²
 * @returns æ ¼å¼åŒ–çš„æ—¥æœŸæ–‡æœ¬
 */
const formatDate = (dateString: string): string => {
  try {
    const date = new Date(dateString)
    return date.toLocaleDateString('zh-CN')
  } catch {
    return 'æœªçŸ¥æ—¥æœŸ'
  }
}

/**
 * è§£ææ ‡ç­¾å­—ç¬¦ä¸²ä¸ºæ•°ç»„
 * å°†é€—å·åˆ†éš”çš„æ ‡ç­¾å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ ‡ç­¾æ•°ç»„
 * @param tags æ ‡ç­¾å­—ç¬¦ä¸²
 * @returns æ ‡ç­¾æ•°ç»„
 */
const getTagArray = (tags: string): string[] => {
  if (!tags) return []
  return tags.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0)
}

/**
 * åŠ è½½çƒ­é—¨æ–‡ç« æ•°æ®
 * ä»APIè·å–çƒ­é—¨æ–‡ç« åˆ—è¡¨å¹¶æ›´æ–°ç»„ä»¶çŠ¶æ€
 */
const loadPopularArticles = async () => {
  try {
    loading.value = true
    error.value = ''
    
    // è·å–çƒ­é—¨æ–‡ç« ï¼ˆæŒ‰ç‚¹èµæ•°æˆ–æµè§ˆé‡æ’åºï¼Œé™åˆ¶6æ¡ï¼‰
    const response = await articleApi.getPopularArticles(6)
    articles.value = response || []
  } catch (err) {
    console.error('åŠ è½½çƒ­é—¨æ–‡ç« å¤±è´¥:', err)
    error.value = 'æ— æ³•åŠ è½½æ–‡ç« æ•°æ®'
    articles.value = []
  } finally {
    loading.value = false
  }
}

// ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
onMounted(() => {
  loadPopularArticles()
})
</script>

<style scoped>
.section-title {
  font-size: 1.5rem;
  margin-top: 0;
  margin-bottom: 24px;
  color: #1a202c;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.article-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 24px;
  margin-bottom: 50px;
}

.loading-container, .error-container, .empty-container {
  text-align: center;
  padding: 40px 20px;
  color: #6b7280;
}

.loading-spinner {
  width: 32px;
  height: 32px;
  border: 3px solid #f3f4f6;
  border-top: 3px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 12px;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.article-stats {
  font-size: 0.75rem;
  color: #6b7280;
}

.article-tags {
  margin: 8px 0 12px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.tag {
  background: #e5e7eb;
  color: #374151;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 500;
}

.article-card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
  padding: 20px;
  transition: all 0.3s ease;
  cursor: pointer;
  border: 1px solid rgba(226, 232, 240, 0.8);
  position: relative;
  height: 280px; /* è°ƒæ•´ä¸º4:3æ¯”ä¾‹ï¼Œçº¦280pxé«˜åº¦ */
  display: flex;
  flex-direction: column;
}

.article-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
  border-color: #667eea;
}

.article-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.article-category {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

.article-rating {
  font-size: 0.85rem;
  color: #f6ad55;
  font-weight: 500;
}

.article-title {
  font-size: 1.2rem;
  margin: 0 0 8px 0; /* å‡å°‘æ ‡é¢˜å’Œæ‘˜è¦ä¹‹é—´çš„é—´è· */
  color: #1a202c;
  font-weight: 600;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2; /* æ ‡é¢˜æœ€å¤š2è¡Œ */
  line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  min-height: 2.8rem; /* ç¡®ä¿æ ‡é¢˜åŒºåŸŸé«˜åº¦ä¸€è‡´ */
}

.article-excerpt {
  color: #718096;
  line-height: 1.5;
  margin-bottom: 12px; /* å‡å°‘æ‘˜è¦åº•éƒ¨é—´è· */
  font-size: 0.9rem;
  flex: 1; /* è®©æ‘˜è¦å æ®å‰©ä½™ç©ºé—´ */
  display: -webkit-box;
  -webkit-line-clamp: 3; /* ç²¾ç¡®æ§åˆ¶è¡Œæ•° */
  line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  white-space: pre-line; /* ä¿æŒæ¢è¡Œï¼ŒæŠ˜å å¤šä½™ç©ºæ ¼ */
  word-wrap: break-word; /* é•¿å•è¯æ¢è¡Œ */
  overflow-wrap: break-word; /* ç¡®ä¿æ¢è¡Œå…¼å®¹æ€§ */
  height: calc(1.5em * 3); /* ç²¾ç¡®æ§åˆ¶é«˜åº¦ï¼Œé¿å…åŠè¡Œæ˜¾ç¤º */
  max-height: calc(1.5em * 3); /* æœ€å¤§é«˜åº¦é™åˆ¶ */
}

.article-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #a0aec0;
  font-size: 0.85rem;
  margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
}

.article-author {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

.author-name {
  color: #4a5568;
}

.article-date {
  color: #cbd5e0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .article-grid {
    grid-template-columns: 1fr;
  }
  
  .article-card {
    height: 360px; /* ç§»åŠ¨ç«¯ç¨å¾®é™ä½é«˜åº¦ */
  }
}

@media (max-width: 480px) {
  .article-card {
    padding: 20px;
    height: 340px; /* å°å±å¹•è¿›ä¸€æ­¥é™ä½é«˜åº¦ */
  }
}
</style>
